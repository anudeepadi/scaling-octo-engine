platform :ios, min_ios_version = "13.0"

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV["COCOAPODS_DISABLE_STATS"] = "true"

project "Runner", {
  "Debug" => :debug,
  "Profile" => :release,
  "Release" => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join("..", "Flutter", "Generated.xcconfig"), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

require File.expand_path(File.join("packages", "flutter_tools", "bin", "podhelper"), flutter_root)

flutter_ios_podfile_setup

target "Runner" do
  use_frameworks!
  use_modular_headers!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  target "RunnerTests" do
    inherit! :search_paths
  end
end

post_install do |installer|
  # Fix for BoringSSL-GRPC GCC_WARN_INHIBIT_ALL_WARNINGS flag issue
  installer.pods_project.targets.each do |target|
    if target.name == 'BoringSSL-GRPC'
      target.source_build_phase.files.each do |file|
        if file.settings && file.settings['COMPILER_FLAGS']
          flags = file.settings['COMPILER_FLAGS'].split
          flags.reject! { |flag| flag == '-GCC_WARN_INHIBIT_ALL_WARNINGS' }
          file.settings['COMPILER_FLAGS'] = flags.join(' ')
        end
      end
    end
  end
  
  # Fix for gRPC-Core template issue
  installer.pods_project.targets.each do |target|
    if target.name == 'gRPC-Core'
      target.build_configurations.each do |config|
        # Remove -G compiler flag causing build errors
        config.build_settings['OTHER_CFLAGS'] ||= ['$(inherited)']
        if config.build_settings['OTHER_CFLAGS'].include?('-G')
          config.build_settings['OTHER_CFLAGS'].delete('-G')
        end
        
        # Add settings to disable specific warnings
        config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
        config.build_settings['CLANG_WARN_DOCUMENTATION_COMMENTS'] = 'NO'
        
        # Add compiler flags to handle template syntax issues
        config.build_settings['OTHER_CPLUSPLUSFLAGS'] = '$(inherited) -Wno-error=deprecated-declarations -Wno-error=deprecated-register -Wno-error=nullability-completeness -Wno-error=availability -Wno-deprecated-declarations -std=c++17'
      end
    end
  end
  
  # Apply Flutter additional iOS build settings
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
  end
  
  # Fix permissions for gRPC-Core files to be writable and patch the file
  pods_root = Dir.pwd + '/Pods'
  system("chmod -R u+w #{pods_root}/gRPC-Core")
  
  # Patch the file directly in the post_install hook
  basic_seq_file = "#{pods_root}/gRPC-Core/src/core/lib/promise/detail/basic_seq.h"
  if File.exist?(basic_seq_file)
    puts "Found file to patch: #{basic_seq_file}"
    content = File.read(basic_seq_file)
    fixed_content = content.gsub('Traits::template CallSeqFactory', 'Traits::CallSeqFactory')
    File.write(basic_seq_file, fixed_content)
    puts "Patched gRPC-Core basic_seq.h file successfully"
  else
    puts "Warning: Could not find #{basic_seq_file} to patch"
  end
end